{% extends "base.html" %}
{% block header %}
<script type="text/javascript">

  function saveConfig(){
    // build the json post
    postData = {"mode": $('#config_mode').val(),
               "path": $('#config_path').val(),
               "update": $('#config_update').val(),
               "increment": parseInt($('#config_increment').val()),
               "start": parseInt($('#config_start').val()),
               "end": parseInt($('#config_end').val()) };

    // display represented as an array
    display = [];
    if($('#config_display_title').is(':checked'))
    {
      display.push('title');
    }

    if($('#config_display_timecode').is(':checked'))
    {
      display.push('timecode');
    }

    if($('#config_display_ip').is(':checked'))
    {
      display.push('ip');
    }

    postData.display = display;

    if($('#config_allow_seek').is(':checked'))
    {
      postData.allow_seek = true
    }
    else
    {
        postData.allow_seek = false
    }

    $.ajax({type: 'POST', contentType: 'application/json', url: '/api/configuration', data: JSON.stringify(postData), success: function(data, status, request){

      if(data.success)
      {
        showFlash(data.message, 'success')
      }
      else
      {
        showFlash(data.message, 'error');
      }
    }});

  }

  function openFileBrowser(){
    $('#file_browser').show();
  }

  function closeFileBrowser(){
    $('#file_browser').hide();
  }

  function selectPath(path){
    if($('#config_mode').val() == 'dir')
    {
      // use the current dir path
      path =  $('#file_path').html();
    }

    $('#config_path').val(path);

    // close the file browser
    closeFileBrowser();
  }

  function toggleDirSelect(){
    $('#directory_select_button').toggle();

    if($('#file_browser').is(':visible')){
      // if currently browsing, refresh the file list
      loadFiles($('#file_path').html());
    }
  }

  function makePathLink(path, name, funcName = 'loadFiles'){
    return '<a href="#" onClick="return ' + funcName + '(\'' + path + '\')">' + name + '</a>';
  }

  function loadFiles(path){
    //get the Mode
    mode = $('#config_mode').val();

    $.ajax({type: 'GET', contentType: 'application/json', url: '/api/browse_files/' + mode + "/" + path, success: function(data, status, request){

      if(data.success)
      {

        $('#file_path').html(data.path)

        fileList = "";

        //create the UP Level icon, if not at root
        if(data.path != '/'){
          splitPath = data.path.split('/');
          splitPath.pop();

          fileList = makePathLink(splitPath.join('/'),'..') + "<br />";
        }

        //build the html list
        for(i = 0; i < data.dirs.length; i++)
        {
          fileList = fileList + makePathLink(data.path + '/' + data.dirs[i], data.dirs[i]) + '<br />';
        }

        //build the html list
        for(i = 0; i < data.files.length; i++)
        {
          if(mode == 'file')
          {
            fileList = fileList + makePathLink(data.path + '/' + data.files[i], data.files[i], 'selectPath') + '<br />';
          }
          else
          {
            fileList = fileList + data.files[i] + '<br />';
          }
        }

        $('#file_list').html(fileList);
      }
    }});

    return false;
  }
</script>
{% endblock %}
{% block content %}
<div class="container">
  <div class="row my-1">
    <div class="col-md-4 align-self-center">
      <b>Mode</b>
    </div>
    <div class="col-md-8">
      <select class="custom-select" id="config_mode" onChange="toggleDirSelect()">
        <option value="file" {{ 'selected' if config['mode'] == 'file' else '' }}>File</option>
        <option value="dir" {{ 'selected' if config['mode'] == 'dir' else '' }}>Directory</option>
      </select>
    </div>
  </div>
  <div class="row my-2 bg-light">
    <div class="col-md-12">
      The current play mode, can be a specific file or a full directory
    </div>
  </div>
  <div class="row my-1">
    <div class="col-md-4 align-self-center">
      <b>Path</b>
    </div>
    <div class="col-md-6">
      <input type="text" id="config_path" class="form-control" value="{{ config['path'] }}" readonly />
    </div>
    <div class="col-md-2">
      <button class="btn btn-primary" onClick="openFileBrowser()">Browse</button>
    </div>
  </div>
  <div class="row my-1" id="file_browser" style="display:none">
    <div class="col-md-4">
      <!-- nothing here -->
    </div>
    <div class="col-md-8">
      <div class="p-2 font-weight-bold">
        Path: <span id="file_path">{{ config['path'] }}</span>
      </div>
      <div id="file_list" class="m-2 p-2 border border-secondary">
      </div>
      <div align="center" class="my-1">
        <button id="directory_select_button" class="btn btn-secondary" onClick="selectPath('')">Select Directory</button>
        <button class="btn btn-danger" onClick="closeFileBrowser()">Close</button>
      </div>
    </div>
  </div>
  <div class="row my-2 bg-light">
    <div class="col-md-12">
      The full system path to either the file or directory VSMP should pull from. This will be verified to exist upon save.
    </div>
  </div>
  <div class="row my-1">
    <div class="col-md-4 align-self-center">
      <b>Update Time</b>
    </div>
    <div class="col-md-8">
      <input type="text" id="config_update" class="form-control" value="{{ config['update'] }}" />
    </div>
  </div>
  <div class="row my-2 bg-light">
    <div class="col-md-12">
      How often to update the sign, given as a <a href="http://en.wikipedia.org/wiki/Cron">cron expression</a>
    </div>
  </div>
  <div class="row my-1">
    <div class="col-md-4 align-self-center">
      <b>Frames to increment</b>
    </div>
    <div class="col-md-8">
      <input type="text" id="config_increment" class="form-control" value="{{ config['increment'] }}" />
    </div>
  </div>
  <div class="row my-2 bg-light">
    <div class="col-md-12">
      How many frames to increment on each update.
    </div>
  </div>
  <div class="row my-1">
    <div class="col-md-4 align-self-center">
      <b>Start time skip</b>
    </div>
    <div class="col-md-8">
      <input type="text" id="config_start" class="form-control" value="{{ config['start'] }}" />
    </div>
  </div>
  <div class="row my-2 bg-light">
    <div class="col-md-12">
      How many <i>seconds</i> in to the video to skip when starting a new video
    </div>
  </div>
  <div class="row my-1">
    <div class="col-md-4 align-self-center">
      <b>End time skip</b>
    </div>
    <div class="col-md-8">
      <input type="text" id="config_end" class="form-control" value="{{ config['end'] }}" />
    </div>
  </div>
  <div class="row my-2 bg-light">
    <div class="col-md-12">
      How many <i>seconds</i> in to the video to skip at the end of a video, useful for skipping credit sequences
    </div>
  </div>
  <div class="row my-1">
    <div class="col-md-4 align-self-center">
      <b>Additional display options</b>
    </div>
    <div class="col-md-8">
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="config_display_title" name="config_display" value="title" {{ 'checked' if 'title' in config['display'] else '' }}>
        <label class="form-check-label" for="config_display_title">Title</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="config_display_timecode" name="config_display" value="timecode" {{ 'checked' if 'timecode' in config['display'] else '' }}>
        <label class="form-check-label" for="config_display_timecode">Timecode</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="config_display_ip" name="config_display" value="ip" {{ 'checked' if 'ip' in config['display'] else '' }}>
        <label class="form-check-label" for="config_display_ip">Device IP</label>
      </div>
    </div>
  </div>
  <div class="row my-2 bg-light">
    <div class="col-md-12">
      Optionally display the video title, timecode, or device IP address below the video on the display. The device IP is useful for finding the device on the network.
    </div>
  </div>
  <div class="row my-1">
    <div class="col-md-4 align-self-center">
      <b>Allow seeking</b>
    </div>
    <div class="col-md-8">
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="config_allow_seek" name="config_allow_seek" value="allow_seek" {{ 'checked' if config['allow_seek'] else '' }}>
        <label class="form-check-label" for="config_allow_seek">Allow</label>
      </div>
    </div>
  </div>
  <div class="row my-2 bg-light">
    <div class="col-md-12">
      Locks or unlocks seeking when clicking the progress bar in the web interface. Turning this off doesn't affect seeking using the api seek control.
    </div>
  </div>
  <div class="row my-3">
    <div class="col-md-12" align="center">
      <button class="btn btn-primary" onClick="saveConfig()">Save</button>
    </div>
  </div>
</div>
<script type="text/javascript">
$(document).ready(function () {
    loadFiles("{{ config['path'] }}");
})
</script>
{% endblock %}
